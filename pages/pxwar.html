<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>PX WAR</title>
<style>
:root {
  --neon-void: #f0f;
  --neon-peace: #0ff;
  --neon-green: #0f3;
  --bg-dark: #050508;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
body { background: var(--bg-dark); color: #fff; overflow: hidden; width: 100vw; height: 100vh; user-select: none; }
#app { width: 100%; height: 100%; position: relative; }
.screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; background: radial-gradient(circle, #1a1a2e 0%, #050508 100%); transition: opacity 0.5s; }
.hidden { display: none !important; }
h1 { font-size: 80px; font-weight: 900; color: var(--neon-void); text-shadow: 0 0 20px var(--neon-void); letter-spacing: 12px; margin-bottom: 40px; font-style: italic; }
.btn { background: rgba(255, 255, 255, 0.03); border: 2px solid var(--neon-green); color: var(--neon-green); padding: 15px 35px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 5px; transition: all 0.3s; min-width: 280px; margin: 8px; display: flex; align-items: center; justify-content: center; gap: 15px; text-transform: uppercase; }
.btn svg { width: 22px; height: 22px; fill: currentColor; }
.btn:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 30px var(--neon-green); transform: translateY(-3px); }
.weapon-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; max-width: 1000px; margin: 20px; }
.weapon-card { background: rgba(20,20,35,0.9); border: 1px solid #444; padding: 15px; text-align: center; cursor: pointer; transition: 0.3s; }
.weapon-card.selected { border-color: var(--neon-void); box-shadow: inset 0 0 15px rgba(255, 0, 255, 0.2); background: rgba(255, 0, 255, 0.05); }
.setting-row { display: flex; align-items: center; justify-content: space-between; width: 450px; margin: 10px; padding: 12px 20px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
#gameCanvas { display: block; background: #000; cursor: crosshair; }
.hud-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 25px; }
.status-bar { display: flex; justify-content: space-between; align-items: flex-start; }
.score-box { background: rgba(0,0,0,0.8); padding: 12px 30px; border-radius: 50px; border: 1px solid #444; font-size: 20px; font-weight: 900; pointer-events: none; }
.void-score { color: var(--neon-void); text-shadow: 0 0 10px var(--neon-void); }
.peace-score { color: var(--neon-peace); text-shadow: 0 0 10px var(--neon-peace); }
.player-panel { position: absolute; bottom: 30px; left: 30px; background: rgba(0,0,0,0.8); padding: 20px; border-left: 6px solid var(--neon-void); width: 300px; }
.health-track { width: 100%; height: 10px; background: #222; margin: 10px 0; border-radius: 5px; overflow: hidden; }
.health-bar { height: 100%; background: linear-gradient(90deg, #f0f, #a0f); transition: width 0.3s; }
#spectatorUI { position: absolute; top: 100px; width: 100%; text-align: center; color: #ff0; font-weight: bold; font-size: 20px; text-shadow: 2px 2px 4px #000; letter-spacing: 2px; }
.mobile-controls { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: space-between; padding: 0 60px; pointer-events: none; }
.joystick-base { width: 150px; height: 150px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; position: relative; pointer-events: all; }
.joystick-stick { width: 60px; height: 60px; background: var(--neon-void); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); box-shadow: 0 0 20px var(--neon-void); }
.action-cluster { display: flex; gap: 25px; pointer-events: all; }
.btn-circle { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--neon-green); background: rgba(0,255,51,0.15); display: flex; align-items: center; justify-content: center; font-size: 30px; }
.countdown-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:2000; }
.countdown-txt { font-size: 200px; font-weight: 900; color: var(--neon-void); animation: pulse 1s infinite; }
@keyframes pulse { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
.game-over-panel { background: rgba(0,0,0,0.95); border: 2px solid var(--neon-void); padding: 60px; text-align: center; border-radius: 15px; }
</style>
</head>
<body>
<div id="app">
  <div id="loadingScreen" class="screen">
    <div style="font-size: 28px; letter-spacing: 8px; color: var(--neon-green);">PX WAR SERVER CONNECTING...</div>
  </div>
  <div id="mainMenu" class="screen hidden">
    <h1>PX WAR</h1>
    <button class="btn" onclick="showScreen('modeSelection')"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> START MISSION</button>
    <button class="btn" onclick="showScreen('loadoutScreen')"><svg viewBox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.97 4.65c-.31.18-.69.18-1 0l-7.97-4.65c-.32-.17-.53-.5-.53-.88v-9c0-.38.21-.71.53-.88l7.97-4.65c.31-.18.69-.18 1 0l7.97 4.65c.32.17.53.5.53.88v9z"/></svg> ARMORY</button>
    <button class="btn" onclick="showScreen('settingsScreen')"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg> SETTINGS</button>
  </div>
  <div id="settingsScreen" class="screen hidden">
    <h2>SYSTEM CONFIG</h2>
    <div class="setting-row"><span>CONTROL</span><button class="btn" style="min-width:160px" id="setDevice" onclick="updateSetting('device')">PC</button></div>
    <div class="setting-row"><span>DIFFICULTY</span><button class="btn" style="min-width:160px" id="setDiff" onclick="updateSetting('difficulty')">NORMAL</button></div>
    <div class="setting-row"><span>AUDIO</span><button class="btn" style="min-width:160px" id="setAudio" onclick="updateSetting('audio')">ENABLED</button></div>
    <button class="btn" style="margin-top:40px; border-color:#666" onclick="showScreen('mainMenu')">RETURN</button>
  </div>
  <div id="modeSelection" class="screen hidden">
    <h2>OPERATION TYPE</h2>
    <button class="btn" onclick="startVote('1v1')">1V1 DUEL</button>
    <button class="btn" onclick="startVote('2v2')">2V2 BATTLE</button>
    <button class="btn" onclick="startVote('3v3')">3V3 SQUAD</button>
    <button class="btn" onclick="startVote('tdm')">TEAM DEATHMATCH (5V5)</button>
    <button class="btn" onclick="startVote('ffa')">FREE FOR ALL</button>
    <button class="btn" style="border-color:#666" onclick="showScreen('mainMenu')">BACK</button>
  </div>
  <div id="loadoutScreen" class="screen hidden">
    <h2>ARMORY</h2>
    <div id="weaponGrid" class="weapon-grid"></div>
    <button class="btn" onclick="showScreen('mainMenu')">CONFIRM</button>
  </div>
  <div id="voteScreen" class="screen hidden">
    <h2>TARGET LOCATION</h2>
    <div id="voteGrid" style="display:flex; gap:20px; margin-bottom:30px"></div>
    <button id="deployBtn" class="btn hidden" onclick="initGame()">DEPLOY</button>
  </div>
  <div id="gameScreen" class="screen hidden">
    <canvas id="gameCanvas"></canvas>
    <div class="hud-overlay">
      <div id="spectatorUI" class="hidden">SPECTATOR MODE: MOVE CAMERA TO EXPLORE</div>
      <div class="status-bar">
        <button class="btn" style="min-width:120px; border-color:red; pointer-events:all" onclick="abortMission()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> ABORT</button>
        <div class="score-box">
          <span class="void-score">VOID: <span id="sVoid">0</span></span>
          <span style="margin: 0 20px; opacity:0.3">|</span>
          <span class="peace-score">PEACE: <span id="sPeace">0</span></span>
        </div>
        <div style="width:120px"></div>
      </div>
      <div class="player-panel" id="playerPanel">
        <div id="curWep" style="font-weight:bold; color:var(--neon-void); font-size: 20px;">AK47</div>
        <div class="health-track"><div id="curHP" class="health-bar" style="width:100%"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:14px">
          <span>AMMO</span><span><span id="curAmmo">30</span> / <span id="curMag">30</span></span>
        </div>
      </div>
    </div>
    <div id="mobileUI" class="mobile-controls hidden">
      <div class="joystick-base" id="joyBase"><div class="joystick-stick" id="joyStick"></div></div>
      <div class="action-cluster">
        <div class="btn-circle" id="reloadBtn">ðŸ”„</div>
        <div class="btn-circle" style="width:110px; height:110px; border-color:var(--neon-void)" id="fireBtn">ðŸ”¥</div>
      </div>
    </div>
    <div id="countdownLayer" class="countdown-screen hidden"><div id="countdownVal" class="countdown-txt">3</div></div>
    <div id="gameOverScreen" class="screen hidden" style="background:rgba(0,0,0,0.9)">
      <div class="game-over-panel">
        <h1 id="victoryTxt" style="font-size: 80px;">END</h1>
        <p id="finalScore" style="margin-bottom: 40px;"></p>
        <button class="btn" onclick="initGame()">RE-ENGAGE</button>
        <button class="btn" style="border-color:#666" onclick="abortMission()">MAIN MENU</button>
      </div>
    </div>
  </div>
</div>
<script>
const AudioSys = {
  ctx: null,
  init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
  play(t) {
    this.init(); if(state.audio === 'DISABLED') return;
    const o = this.ctx.createOscillator(), g = this.ctx.createGain();
    o.connect(g); g.connect(this.ctx.destination);
    const n = this.ctx.currentTime;
    if(t==='fire'){ o.type='square'; o.frequency.setValueAtTime(180, n); o.frequency.exponentialRampToValueAtTime(10, n+0.1); g.gain.setValueAtTime(0.1, n); o.start(); o.stop(n+0.1); }
    else if(t==='reload'){ o.type='triangle'; o.frequency.setValueAtTime(400, n); o.frequency.linearRampToValueAtTime(800, n+0.2); g.gain.setValueAtTime(0.05, n); o.start(); o.stop(n+0.3); }
    else if(t==='hit'){ o.type='sine'; o.frequency.setValueAtTime(1000, n); g.gain.setValueAtTime(0.05, n); o.start(); o.stop(n+0.05); }
  }
};
const difficulties = {
  weak: { speed: 0.2, accM: 5.0, hp: 40 },
  normal: { speed: 0.35, accM: 3.5, hp: 60 },
  hard: { speed: 0.6, accM: 2.0, hp: 100 },
  nightmare: { speed: 1.0, accM: 0.8, hp: 150 }
};
const weapons = {
  ak47: { name: 'AK47', dmg: 34, rate: 110, mag: 30, acc: 0.1, reload: 2.2, color: '#8B4513' },
  aug: { name: 'AUG', dmg: 32, rate: 115, mag: 30, acc: 0.05, reload: 2.5, color: '#2d5a27' },
  mp5: { name: 'MP5', dmg: 21, rate: 80, mag: 30, acc: 0.08, reload: 1.6, color: '#2F4F4F' },
  mp7: { name: 'MP7', dmg: 19, rate: 70, mag: 40, acc: 0.12, reload: 1.7, color: '#333' },
  p90: { name: 'P90', dmg: 17, rate: 55, mag: 50, acc: 0.15, reload: 2.8, color: '#444' },
  m14: { name: 'M14', dmg: 55, rate: 380, mag: 20, acc: 0.03, reload: 2.6, color: '#654321' },
  m16: { name: 'M16', dmg: 33, rate: 130, mag: 30, acc: 0.07, reload: 2.2, color: '#1a1a1a' },
  awp: { name: 'AWP', dmg: 110, rate: 1400, mag: 5, acc: 0.001, reload: 3.8, color: '#000' }
};
const maps = {
  hangar: { 
    name: 'HANGAR-X', 
    bg: '#1a1a23', 
    w: 2500, h: 2000, 
    objs: [{x:600,y:400,w:100,h:800},{x:1800,y:400,w:100,h:800},{x:1000,y:1000,w:500,h:100}] 
  },
  outpost: { 
    name: 'OUTPOST-9', 
    bg: '#2d2620', 
    w: 2200, h: 2200, 
    objs: [{x:0,y:1000,w:800,h:60},{x:1400,y:1000,w:800,h:60},{x:1050,y:200,w:60,h:600}] 
  },
  metro: {
    name: 'METRO-STATION',
    bg: '#2c3e50',
    w: 3000, h: 1800,
    objs: [
      {x:500,y:400,w:2000,h:40}, {x:500,y:1400,w:2000,h:40}, 
      {x:800,y:600,w:60,h:600}, {x:1400,y:600,w:60,h:600}, {x:2000,y:600,w:60,h:600}, 
      {x:200,y:800,w:200,h:200}, {x:2600,y:800,w:200,h:200} 
    ]
  },
  cyber: {
    name: 'CYBER-SQUARE',
    bg: '#0a0e14',
    w: 2000, h: 2000,
    objs: [
      {x:950,y:200,w:100,h:600}, {x:950,y:1200,w:100,h:600},
      {x:200,y:950,w:600,h:100}, {x:1200,y:950,w:600,h:100}, 
      {x:400,y:400,w:150,h:150}, {x:1450,y:400,w:150,h:150}, 
      {x:400,y:1450,w:150,h:150}, {x:1450,y:1450,w:150,h:150}
    ]
  },
  wasteland: {
    name: 'RED-WASTELAND',
    bg: '#4d2a22',
    w: 3200, h: 2400,
    objs: [
      {x:400,y:400,w:300,h:300}, {x:2500,y:1700,w:300,h:300}, 
      {x:1500,y:1100,w:200,h:200}, 
      {x:800,y:1800,w:600,h:80}, {x:1800,y:500,w:600,h:80}, 
      {x:2000,y:2000,w:80,h:300}, {x:500,y:800,w:80,h:300}
    ]
  },
  lab: {
    name: 'BIO-LAB',
    bg: '#1e272e',
    w: 2400, h: 2000,
    objs: [
      {x:0,y:0,w:2400,h:100}, {x:0,y:1900,w:2400,h:100},
      {x:400,y:400,w:40,h:1200}, {x:1960,y:400,w:40,h:1200},
      {x:800,y:400,w:800,h:40}, {x:800,y:1560,w:800,h:40},
      {x:1150,y:800,w:100,h:400}
    ]
  },
  maze: {
    name: 'THE-MAZE',
    bg: '#000000',
    w: 2000, h: 2000,
    objs: [
      {x:300,y:0,w:40,h:600}, {x:0,y:300,w:600,h:40},
      {x:1000,y:0,w:40,h:800}, {x:1400,y:600,w:600,h:40},
      {x:300,y:1000,w:400,h:40}, {x:800,y:1400,w:40,h:600},
      {x:1200,y:1000,w:40,h:1000}, {x:1500,y:1500,w:500,h:40},
      {x:0,y:1700,w:600,h:40}
    ]
  }
};
let state = { device: 'PC', difficulty: 'normal', audio: 'ENABLED', weapon: 'ak47', mode: 'tdm', map: 'hangar' };
let game = { active: false, setupPhase: true, startTime: 0, players: [], bullets: [], cam: {x:0, y:0}, scores: {void:0, peace:0}, cvs: null, ctx: null, keys: {}, mouse: {x:0, y:0, down:false}, joy: {dx:0, dy:0, active:false} };
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(id === 'loadoutScreen') renderArmory(); }
function updateSetting(t) {
  if(t==='device'){ state.device = state.device==='PC'?'MOBILE':'PC'; document.getElementById('setDevice').innerText=state.device; }
  else if(t==='difficulty'){ const l=Object.keys(difficulties); let i=(l.indexOf(state.difficulty)+1)%l.length; state.difficulty=l[i]; document.getElementById('setDiff').innerText=state.difficulty.toUpperCase(); }
  else if(t==='audio'){ state.audio = state.audio==='ENABLED'?'DISABLED':'ENABLED'; document.getElementById('setAudio').innerText=state.audio; }
}
function renderArmory() {
  const g = document.getElementById('weaponGrid'); g.innerHTML = '';
  Object.keys(weapons).forEach(k => {
    const w = weapons[k]; const c = document.createElement('div');
    c.className = `weapon-card ${state.weapon===k?'selected':''}`;
    c.innerHTML = `<strong>${w.name}</strong><br><small>DMG:${w.dmg}</small>`;
    c.onclick = () => { state.weapon=k; renderArmory(); }; g.appendChild(c);
  });
}
function startVote(m) {
  state.mode = m; showScreen('voteScreen'); const g = document.getElementById('voteGrid'); g.innerHTML = '';
  Object.keys(maps).forEach(k => {
    const c = document.createElement('div'); c.className = 'weapon-card'; c.innerHTML = `<b>${maps[k].name}</b>`;
    c.onclick = () => { document.querySelectorAll('#voteGrid .weapon-card').forEach(x => x.classList.remove('selected')); c.classList.add('selected'); state.map=k; document.getElementById('deployBtn').classList.remove('hidden'); };
    g.appendChild(c);
  });
}
function initGame() {
  showScreen('gameScreen'); game.cvs = document.getElementById('gameCanvas'); game.ctx = game.cvs.getContext('2d');
  game.cvs.width = window.innerWidth; game.cvs.height = window.innerHeight;
  game.players = []; game.bullets = []; game.scores = {void:0, peace:0}; game.setupPhase = true; game.active = false;
  const m = maps[state.map];
  game.players.push(spawn(300, m.h/2, 'VOID', true));
  let vc = 0, pc = 0;
  if(state.mode==='1v1') pc=1;
  else if(state.mode==='2v2'){ vc=1; pc=2; }
  else if(state.mode==='3v3'){ vc=2; pc=3; }
  else if(state.mode==='tdm'){ vc=4; pc=5; }
  else if(state.mode==='ffa'){ pc=7; }
  for(let i=0; i<vc; i++) game.players.push(spawn(200+Math.random()*400, Math.random()*m.h, 'VOID', false));
  for(let i=0; i<pc; i++) {
    const t = state.mode==='ffa' ? 'PEACE_'+i : 'PEACE';
    game.players.push(spawn(m.w - (200+Math.random()*400), Math.random()*m.h, t, false));
  }
  if(state.device==='MOBILE') document.getElementById('mobileUI').classList.remove('hidden');
  else document.getElementById('mobileUI').classList.add('hidden');
  document.getElementById('spectatorUI').classList.add('hidden');
  document.getElementById('playerPanel').classList.remove('hidden');
  bind(); runCount();
}
function runCount() {
  const l = document.getElementById('countdownLayer'), v = document.getElementById('countdownVal');
  l.classList.remove('hidden'); let c=3; v.innerText=c;
  const t = setInterval(() => {
    c--; if(c>0) v.innerText=c; else if(c===0) v.innerText='GO';
    else { clearInterval(t); l.classList.add('hidden'); game.active=true; game.setupPhase=false; game.startTime=Date.now(); requestAnimationFrame(loop); }
  }, 1000);
}
function spawn(x, y, team, human) {
  const wk = human?state.weapon:Object.keys(weapons)[Math.floor(Math.random()*8)];
  const d = difficulties[state.difficulty];
  return { x, y, team, human, hp: human?100:d.hp, maxHp: human?100:d.hp, wep: {...weapons[wk]}, ammo: weapons[wk].mag, angle: 0, recoil: 0, reloading: false, reloadRot: 0, lastFire: 0, target: null, aiTimer: 0 };
}
function bind() {
  window.onkeydown = e => { game.keys[e.key.toLowerCase()] = true; if(e.key==='r') reload(game.players[0]); };
  window.onkeyup = e => { game.keys[e.key.toLowerCase()] = false; };
  window.onmousemove = e => { game.mouse.x = e.clientX; game.mouse.y = e.clientY; };
  window.onmousedown = () => game.mouse.down = true; window.onmouseup = () => game.mouse.down = false;
  if(state.device === 'MOBILE' || 'ontouchstart' in window) {
    const b = document.getElementById('joyBase');
    const moveTouch = e => { e.preventDefault(); const t = e.touches[0], r = b.getBoundingClientRect(); const dx = t.clientX-(r.left+r.width/2), dy = t.clientY-(r.top+r.height/2); const dist = Math.min(50, Math.sqrt(dx*dx+dy*dy)), ang = Math.atan2(dy,dx); game.joy.dx = Math.cos(ang)*(dist/50); game.joy.dy = Math.sin(ang)*(dist/50); game.joy.active=true; document.getElementById('joyStick').style.left=`calc(50% + ${Math.cos(ang)*dist}px)`; document.getElementById('joyStick').style.top=`calc(50% + ${Math.sin(ang)*dist}px)`; };
    const endTouch = () => { game.joy.active=false; document.getElementById('joyStick').style.left='50%'; document.getElementById('joyStick').style.top='50%'; };
    b.addEventListener('touchmove', moveTouch, {passive:false}); b.addEventListener('touchend', endTouch);
    document.getElementById('fireBtn').ontouchstart = () => game.mouse.down=true; document.getElementById('fireBtn').ontouchend = () => game.mouse.down=false;
    document.getElementById('reloadBtn').onclick = () => reload(game.players[0]);
  }
}
function reload(p) {
  if(!p || p.reloading || p.ammo===p.wep.mag) return;
  p.reloading=true; AudioSys.play('reload');
  let s=Date.now(), ms=p.wep.reload*1000;
  const f = () => { let el=Date.now()-s; p.reloadRot=(el/ms)*Math.PI*2; if(el<ms) requestAnimationFrame(f); else { p.ammo=p.wep.mag; p.reloading=false; p.reloadRot=0; } }; f();
}
function abortMission() { game.active = false; document.getElementById('gameScreen').classList.add('hidden'); showScreen('mainMenu'); }
function loop() { if(!game.active) return; update(); draw(); requestAnimationFrame(loop); }
function update() {
  const m = maps[state.map], d = difficulties[state.difficulty];
  const p1 = game.players[0];
  if(p1.hp > 0) { game.cam.x = p1.x - game.cvs.width/2; game.cam.y = p1.y - game.cvs.height/2; }
  else {
    let sx = 0, sy = 0;
    if(state.device==='MOBILE' && game.joy.active){ sx=game.joy.dx*15; sy=game.joy.dy*15; }
    else { if(game.keys.w) sy-=12; if(game.keys.s) sy+=12; if(game.keys.a) sx-=12; if(game.keys.d) sx+=12; }
    game.cam.x += sx; game.cam.y += sy;
    document.getElementById('spectatorUI').classList.remove('hidden');
    document.getElementById('playerPanel').classList.add('hidden');
  }
  game.players.forEach(p => {
    if(p.hp <= 0) return;
    if(p.human) {
      let vx=0, vy=0;
      if(state.device==='MOBILE' && game.joy.active){ vx=game.joy.dx*6; vy=game.joy.dy*6; p.angle=Math.atan2(vy,vx); }
      else { if(game.keys.w) vy-=6; if(game.keys.s) vy+=6; if(game.keys.a) vx-=6; if(game.keys.d) vx+=6; p.angle=Math.atan2(game.mouse.y-game.cvs.height/2, game.mouse.x-game.cvs.width/2); }
      p.x+=vx; p.y+=vy; if(game.mouse.down) fire(p);
      document.getElementById('curAmmo').innerText=p.ammo; document.getElementById('curHP').style.width=p.hp+'%';
    } else { updateAI(p, m, d); }
    p.x=Math.max(25, Math.min(m.w-25, p.x)); p.y=Math.max(25, Math.min(m.h-25, p.y));
    m.objs.forEach(o => { if(collide(p.x, p.y, 22, o)){ const a=Math.atan2(p.y-(o.y+o.h/2), p.x-(o.x+o.w/2)); p.x+=Math.cos(a)*5; p.y+=Math.sin(a)*5; } });
    p.recoil*=0.82;
  });
  game.bullets = game.bullets.filter(b => {
    b.x+=b.vx; b.y+=b.vy; let h=false;
    m.objs.forEach(o => { if(b.x>o.x && b.x<o.x+o.w && b.y>o.y && b.y<o.y+o.h) h=true; });
    game.players.forEach(p => { if(p.hp>0 && p.team!==b.team && Math.sqrt((b.x-p.x)**2+(b.y-p.y)**2)<26){ p.hp-=b.dmg; h=true; if(b.human) AudioSys.play('hit'); if(p.hp<=0){ if(b.team==='VOID') game.scores.void++; else game.scores.peace++; } } });
    return !h && b.x>0 && b.x<m.w && b.y>0 && b.y<m.h;
  });
  document.getElementById('sVoid').innerText=game.scores.void; document.getElementById('sPeace').innerText=game.scores.peace;
  if(!game.setupPhase) checkWin();
}
function updateAI(p, m, d) {
  let target = null, minDist = 600;
  game.players.forEach(o => { if(o.hp>0 && o.team!==p.team){ let dist=Math.sqrt((o.x-p.x)**2+(o.y-p.y)**2); if(dist<minDist){ target=o; minDist=dist; } } });
  let moveAngle = p.angle;
  if(target) { p.angle = Math.atan2(target.y-p.y, target.x-p.x); moveAngle = p.angle; if(minDist < 450) fire(p); }
  else { p.aiTimer--; if(p.aiTimer<=0){ p.target={x:Math.random()*m.w, y:Math.random()*m.h}; p.aiTimer=150; } if(p.target) moveAngle = Math.atan2(p.target.y-p.y, p.target.x-p.x); }
  let probeX = p.x + Math.cos(moveAngle)*60, probeY = p.y + Math.sin(moveAngle)*60, blocked = false;
  m.objs.forEach(o => { if(probeX>o.x && probeX<o.x+o.w && probeY>o.y && probeY<o.y+o.h) blocked=true; });
  if(blocked) moveAngle += Math.PI/2;
  p.x += Math.cos(moveAngle)*d.speed*1.8; p.y += Math.sin(moveAngle)*d.speed*1.8;
  if(p.ammo<=0) reload(p);
}
function fire(p) {
  const n=Date.now(); if(p.reloading || p.ammo<=0 || n-p.lastFire<p.wep.rate) return;
  p.ammo--; p.lastFire=n; p.recoil=12; if(p.human) AudioSys.play('fire');
  const d = difficulties[state.difficulty], accFactor = p.human ? 1 : d.accM;
  const s=(Math.random()-0.5)*p.wep.acc * accFactor, dmg=p.human?p.wep.dmg:p.wep.dmg*0.4;
  game.bullets.push({ x:p.x+Math.cos(p.angle)*35, y:p.y+Math.sin(p.angle)*35, vx:Math.cos(p.angle+s)*16, vy:Math.sin(p.angle+s)*16, dmg, team:p.team, human:p.human });
}
function draw() {
  const m=maps[state.map]; game.ctx.clearRect(0,0,game.cvs.width, game.cvs.height);
  game.ctx.save(); game.ctx.translate(-game.cam.x, -game.cam.y);
  game.ctx.fillStyle=m.bg; game.ctx.fillRect(0,0,m.w, m.h);
  game.ctx.strokeStyle='rgba(255,255,255,0.04)';
  for(let i=0;i<m.w;i+=100){ game.ctx.beginPath(); game.ctx.moveTo(i,0); game.ctx.lineTo(i,m.h); game.ctx.stroke(); }
  for(let i=0;i<m.h;i+=100){ game.ctx.beginPath(); game.ctx.moveTo(0,i); game.ctx.lineTo(m.w,i); game.ctx.stroke(); }
  game.ctx.fillStyle='#0a0a10'; m.objs.forEach(o=>{ game.ctx.fillRect(o.x, o.y, o.w, o.h); });
  game.players.forEach(p => {
    if(p.hp<=0) return;
    game.ctx.save(); game.ctx.translate(p.x, p.y);
    game.ctx.shadowBlur=15; game.ctx.shadowColor=(p.team==='VOID'?'#f0f':'#0ff');
    game.ctx.fillStyle=game.ctx.shadowColor; game.ctx.beginPath(); game.ctx.arc(0,0,24,0,Math.PI*2); game.ctx.fill();
    game.ctx.shadowBlur=0; game.ctx.rotate(p.angle); if(p.reloading) game.ctx.rotate(p.reloadRot);
    game.ctx.fillStyle=p.wep.color; game.ctx.fillRect(18-p.recoil, 12, 38, 11);
    game.ctx.restore();
    game.ctx.fillStyle='rgba(0,0,0,0.6)'; game.ctx.fillRect(p.x-25, p.y-45, 50, 5);
    game.ctx.fillStyle=p.hp>30?'#0f3':'red'; game.ctx.fillRect(p.x-25, p.y-45, 50*(p.hp/p.maxHp), 5);
  });
  game.ctx.fillStyle='#ff0'; game.bullets.forEach(b=>{ game.ctx.beginPath(); game.ctx.arc(b.x, b.y, 4, 0, Math.PI*2); game.ctx.fill(); });
  game.ctx.restore();
}
function checkWin() {
  if(Date.now()-game.startTime < 3500) return;
  const vA = game.players.filter(p=>p.team==='VOID' && p.hp>0).length, pA = game.players.filter(p=>p.team.startsWith('PEACE') && p.hp>0).length;
  if(state.mode==='ffa'){ const tA=game.players.filter(p=>p.hp>0); if(tA.length<=1) finish(tA[0]?tA[0].team+" WIN":"DRAW"); }
  else { if(vA===0) finish("PEACE WINS"); else if(pA===0) finish("VOID WINS"); }
}
function finish(m) { game.active=false; document.getElementById('gameOverScreen').classList.remove('hidden'); document.getElementById('victoryTxt').innerText=m; document.getElementById('finalScore').innerText=`VOID: ${game.scores.void} | PEACE: ${game.scores.peace}`; }
function collide(cx, cy, r, rect) { let x=Math.max(rect.x, Math.min(cx, rect.x+rect.w)), y=Math.max(rect.y, Math.min(cy, rect.y+rect.h)); return ((cx-x)**2+(cy-y)**2)<r**2; }
window.onload = () => { setTimeout(() => showScreen('mainMenu'), 1500); };
</script>
</body>
</html>
