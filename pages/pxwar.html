<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>PX WAR</title>
<style>
:root {
  --neon-void: #f0f;
  --neon-peace: #0ff;
  --neon-green: #0f3;
  --bg-dark: #050508;
  --panel-bg: rgba(20, 20, 35, 0.95);
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }

body {
  background: var(--bg-dark);
  color: #fff;
  overflow: hidden;
  width: 100vw;
  height: 100vh;
  user-select: none;
}

#app { width: 100%; height: 100%; position: relative; }

/* Screens */
.screen {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10;
  background: radial-gradient(circle, #1a1a2e 0%, #050508 100%);
  transition: opacity 0.5s;
}

.hidden { display: none !important; }

/* UI Styling */
h1 {
  font-size: 85px;
  font-weight: 900;
  color: var(--neon-void);
  text-shadow: 0 0 20px var(--neon-void);
  letter-spacing: 15px;
  margin-bottom: 40px;
  font-style: italic;
}

.btn {
  background: rgba(255, 255, 255, 0.03);
  border: 2px solid var(--neon-green);
  color: var(--neon-green);
  padding: 15px 35px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  border-radius: 5px;
  transition: all 0.3s;
  min-width: 280px;
  margin: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  text-transform: uppercase;
}

.btn svg { width: 20px; height: 20px; fill: currentColor; }

.btn:hover {
  background: var(--neon-green);
  color: #000;
  box-shadow: 0 0 30px var(--neon-green);
  transform: translateY(-3px);
}

.weapon-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  max-width: 1000px;
  margin: 20px;
}

.weapon-card {
  background: var(--panel-bg);
  border: 1px solid #444;
  padding: 15px;
  text-align: center;
  cursor: pointer;
  transition: 0.3s;
}

.weapon-card.selected {
  border-color: var(--neon-void);
  box-shadow: inset 0 0 15px rgba(255, 0, 255, 0.2);
  background: rgba(255, 0, 255, 0.05);
}

.setting-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 450px;
  margin: 10px;
  padding: 12px 20px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.1);
}

/* Game HUD */
#gameCanvas { display: block; background: #000; cursor: crosshair; }

.hud-overlay {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  padding: 25px;
}

.status-bar { display: flex; justify-content: space-between; align-items: flex-start; }
.score-box {
  background: rgba(0,0,0,0.8);
  padding: 12px 30px;
  border-radius: 50px;
  border: 1px solid #444;
  font-size: 20px;
  font-weight: 900;
}

.void-score { color: var(--neon-void); text-shadow: 0 0 10px var(--neon-void); }
.peace-score { color: var(--neon-peace); text-shadow: 0 0 10px var(--neon-peace); }

.player-panel {
  position: absolute;
  bottom: 30px; left: 30px;
  background: rgba(0,0,0,0.8);
  padding: 20px;
  border-left: 6px solid var(--neon-void);
  width: 300px;
}

.health-track { width: 100%; height: 10px; background: #222; margin: 10px 0; border-radius: 5px; overflow: hidden; }
.health-bar { height: 100%; background: linear-gradient(90deg, #f0f, #a0f); transition: width 0.3s; }

/* Mobile Controls */
.mobile-controls { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: space-between; padding: 0 60px; pointer-events: none; }
.joystick-base { width: 150px; height: 150px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; position: relative; pointer-events: all; }
.joystick-stick { width: 60px; height: 60px; background: var(--neon-void); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); box-shadow: 0 0 20px var(--neon-void); }
.action-cluster { display: flex; gap: 25px; pointer-events: all; }
.btn-circle { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--neon-green); background: rgba(0,255,51,0.15); display: flex; align-items: center; justify-content: center; font-size: 30px; }

/* Countdown */
.countdown-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:2000; }
.countdown-txt { font-size: 200px; font-weight: 900; color: var(--neon-void); animation: pulse 1s infinite; }
@keyframes pulse { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }

/* Game Over */
.game-over-panel { background: rgba(0,0,0,0.95); border: 2px solid var(--neon-void); padding: 60px; text-align: center; border-radius: 15px; }
</style>
</head>
<body>

<div id="app">
  <!-- Loading Screen -->
  <div id="loadingScreen" class="screen">
    <div style="font-size: 28px; letter-spacing: 8px; color: var(--neon-green);">PX WAR SERVER CONNECTING...</div>
  </div>

  <!-- Main Menu -->
  <div id="mainMenu" class="screen hidden">
    <h1>PX WAR</h1>
    <button class="btn" onclick="showScreen('modeSelection')">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> START MISSION
    </button>
    <button class="btn" onclick="showScreen('loadoutScreen')">
      <svg viewBox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.97 4.65c-.31.18-.69.18-1 0l-7.97-4.65c-.32-.17-.53-.5-.53-.88v-9c0-.38.21-.71.53-.88l7.97-4.65c.31-.18.69-.18 1 0l7.97 4.65c.32.17.53.5.53.88v9z"/></svg> ARMORY
    </button>
    <button class="btn" onclick="showScreen('settingsScreen')">
      <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg> SETTINGS
    </button>
  </div>

  <!-- Settings -->
  <div id="settingsScreen" class="screen hidden">
    <h2>SYSTEM CONFIG</h2>
    <div class="setting-row">
      <span>CONTROL INTERFACE</span>
      <button class="btn" style="min-width:160px; margin:0" id="setDevice" onclick="updateSetting('device')">PC</button>
    </div>
    <div class="setting-row">
      <span>AI INTELLECT</span>
      <button class="btn" style="min-width:160px; margin:0" id="setDiff" onclick="updateSetting('difficulty')">NORMAL</button>
    </div>
    <div class="setting-row">
      <span>AUDIO OUTPUT</span>
      <button class="btn" style="min-width:160px; margin:0" id="setAudio" onclick="updateSetting('audio')">ENABLED</button>
    </div>
    <button class="btn" style="margin-top:40px; border-color:#666" onclick="showScreen('mainMenu')">RETURN</button>
  </div>

  <!-- Mode Selection -->
  <div id="modeSelection" class="screen hidden">
    <h2>OPERATION TYPE</h2>
    <button class="btn" onclick="startVote('1v1')">1v1 DUEL</button>
    <button class="btn" onclick="startVote('2v2')">2v2 BATTLE</button>
    <button class="btn" onclick="startVote('3v3')">3v3 SQUAD</button>
    <button class="btn" onclick="startVote('tdm')">TEAM DEATHMATCH (5v5)</button>
    <button class="btn" onclick="startVote('ffa')">FREE FOR ALL</button>
    <button class="btn" style="border-color:#666" onclick="showScreen('mainMenu')">BACK</button>
  </div>

  <!-- Armory -->
  <div id="loadoutScreen" class="screen hidden">
    <h2>SELECT PRIMARY WEAPON</h2>
    <div id="weaponGrid" class="weapon-grid"></div>
    <button class="btn" onclick="showScreen('mainMenu')">CONFIRM LOADOUT</button>
  </div>

  <!-- Vote Screen -->
  <div id="voteScreen" class="screen hidden">
    <h2>TARGET LOCATION</h2>
    <div id="voteGrid" style="display:flex; gap:20px; margin-bottom:30px"></div>
    <button id="deployBtn" class="btn hidden" onclick="initGame()">DEPLOY TO AREA</button>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="screen hidden">
    <canvas id="gameCanvas"></canvas>
    
    <div class="hud-overlay">
      <div class="status-bar">
        <button class="btn" style="min-width:120px; border-color:red; padding:8px" onclick="abortMission()">ABORT</button>
        <div class="score-box">
          <span class="void-score">VOID: <span id="sVoid">0</span></span>
          <span style="margin: 0 20px; opacity:0.3">|</span>
          <span class="peace-score">PEACE: <span id="sPeace">0</span></span>
        </div>
        <div style="width:120px"></div>
      </div>

      <div class="player-panel">
        <div id="curWep" style="font-weight:bold; color:var(--neon-void); font-size: 20px;">AK47</div>
        <div class="health-track"><div id="curHP" class="health-bar" style="width:100%"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:14px; font-family:monospace">
          <span>AMMO CAPACITY</span>
          <span><span id="curAmmo">30</span> / <span id="curMag">30</span></span>
        </div>
      </div>
    </div>

    <!-- Mobile UI -->
    <div id="mobileUI" class="mobile-controls hidden">
      <div class="joystick-base" id="joyBase"><div class="joystick-stick" id="joyStick"></div></div>
      <div class="action-cluster">
        <div class="btn-circle" id="reloadBtn">ðŸ”„</div>
        <div class="btn-circle" style="width:110px; height:110px; border-color:var(--neon-void); background:rgba(255,0,255,0.1)" id="fireBtn">ðŸ”¥</div>
      </div>
    </div>

    <div id="countdownLayer" class="countdown-screen hidden">
      <div id="countdownVal" class="countdown-txt">3</div>
    </div>

    <div id="gameOverScreen" class="screen hidden" style="background:rgba(0,0,0,0.9)">
      <div class="game-over-panel">
        <h1 id="victoryTxt" style="font-size: 80px;">MISSION END</h1>
        <p id="finalScore" style="font-size: 22px; letter-spacing: 4px; margin-bottom: 40px; color: #aaa;"></p>
        <button class="btn" onclick="initGame()">RE-ENGAGE</button>
        <button class="btn" style="border-color:#666" onclick="abortMission()">MAIN MENU</button>
      </div>
    </div>
  </div>
</div>

<script>
/** AUDIO SYSTEM **/
const AudioSys = {
  ctx: new (window.AudioContext || window.webkitAudioContext)(),
  play(type) {
    if(state.audio === 'DISABLED') return;
    const osc = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    osc.connect(g); g.connect(this.ctx.destination);
    const now = this.ctx.currentTime;

    if(type==='fire') {
      osc.type='square'; osc.frequency.setValueAtTime(160 + Math.random()*40, now);
      osc.frequency.exponentialRampToValueAtTime(20, now+0.1);
      g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.1);
      osc.start(); osc.stop(now+0.1);
    } else if(type==='reload') {
      osc.type='triangle'; osc.frequency.setValueAtTime(440, now);
      osc.frequency.linearRampToValueAtTime(880, now+0.2);
      g.gain.setValueAtTime(0.05, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.3);
      osc.start(); osc.stop(now+0.3);
    } else if(type==='hit') {
      osc.type='sine'; osc.frequency.setValueAtTime(900, now);
      g.gain.setValueAtTime(0.04, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.05);
      osc.start(); osc.stop(now+0.05);
    }
  }
};

/** CONSTANTS **/
const weapons = {
  ak47: { name: 'AK47', dmg: 34, rate: 105, mag: 30, acc: 0.1, reload: 2.2, color: '#8B4513' },
  aug: { name: 'AUG', dmg: 32, rate: 110, mag: 30, acc: 0.05, reload: 2.5, color: '#2d5a27' },
  mp5: { name: 'MP5', dmg: 21, rate: 75, mag: 30, acc: 0.08, reload: 1.6, color: '#2F4F4F' },
  mp7: { name: 'MP7', dmg: 19, rate: 68, mag: 40, acc: 0.12, reload: 1.7, color: '#333' },
  p90: { name: 'P90', dmg: 17, rate: 52, mag: 50, acc: 0.15, reload: 2.8, color: '#444' },
  m14: { name: 'M14', dmg: 52, rate: 350, mag: 20, acc: 0.03, reload: 2.6, color: '#654321' },
  m16: { name: 'M16', dmg: 33, rate: 125, mag: 30, acc: 0.07, reload: 2.2, color: '#1a1a1a' },
  awp: { name: 'AWP', dmg: 110, rate: 1300, mag: 5, acc: 0.001, reload: 3.8, color: '#000' }
};

const difficulties = {
  weak: { speed: 0.4, accM: 13, hp: 70 },
  normal: { speed: 0.6, accM: 7, hp: 100 },
  hard: { speed: 1, accM: 3, hp: 140 },
  nightmare: { speed: 1.3, accM: 1, hp: 200 }
};

const maps = {
  hangar: { name: 'HANGAR-X', bg: '#1a1a23', w: 1800, h: 1200, objs: [{x:400,y:300,w:100,h:600},{x:1300,y:300,w:100,h:600},{x:800,y:500,w:200,h:200}] },
  outpost: { name: 'OUTPOST-9', bg: '#2d2620', w: 1600, h: 1400, objs: [{x:0,y:700,w:700,h:40},{x:900,y:700,w:700,h:40},{x:800,y:200,w:40,h:400}] },
  temple: { name: 'VOID TEMPLE', bg: '#0f0a14', w: 1500, h: 1500, objs: [{x:750,y:750,w:150,h:150,s:'c'},{x:200,y:200,w:100,h:100,s:'c'},{x:1200,y:1200,w:100,h:100,s:'c'}] }
};

/** STATE **/
let state = {
  device: 'PC',
  difficulty: 'normal',
  audio: 'ENABLED',
  weapon: 'ak47',
  mode: 'tdm',
  map: 'hangar'
};

let game = {
  active: false,
  setupPhase: true,
  startTime: 0,
  players: [],
  bullets: [],
  cam: {x:0, y:0},
  scores: {void:0, peace:0},
  cvs: null, ctx: null,
  keys: {},
  mouse: {x:0, y:0, down:false},
  joy: {dx:0, dy:0, active:false}
};

/** CORE FUNCTIONS **/
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id === 'loadoutScreen') renderArmory();
}

function updateSetting(type) {
  if(type === 'device') {
    state.device = state.device === 'PC' ? 'MOBILE' : 'PC';
    document.getElementById('setDevice').innerText = state.device;
  } else if(type === 'difficulty') {
    const list = Object.keys(difficulties);
    let idx = (list.indexOf(state.difficulty) + 1) % list.length;
    state.difficulty = list[idx];
    document.getElementById('setDiff').innerText = state.difficulty.toUpperCase();
  } else if(type === 'audio') {
    state.audio = state.audio === 'ENABLED' ? 'DISABLED' : 'ENABLED';
    document.getElementById('setAudio').innerText = state.audio;
  }
}

function renderArmory() {
  const grid = document.getElementById('weaponGrid');
  grid.innerHTML = '';
  Object.keys(weapons).forEach(k => {
    const w = weapons[k];
    const card = document.createElement('div');
    card.className = `weapon-card ${state.weapon === k ? 'selected' : ''}`;
    card.innerHTML = `<strong>${w.name}</strong><br><small>DMG:${w.dmg} ACC:${(1-w.acc)*100}%</small>`;
    card.onclick = () => { state.weapon = k; renderArmory(); };
    grid.appendChild(card);
  });
}

function startVote(mode) {
  state.mode = mode;
  showScreen('voteScreen');
  const grid = document.getElementById('voteGrid');
  grid.innerHTML = '';
  Object.keys(maps).forEach(k => {
    const card = document.createElement('div');
    card.className = 'weapon-card';
    card.innerHTML = `<b>${maps[k].name}</b>`;
    card.onclick = () => {
      document.querySelectorAll('#voteGrid .weapon-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      state.map = k;
      document.getElementById('deployBtn').classList.remove('hidden');
    };
    grid.appendChild(card);
  });
}

function initGame() {
  showScreen('gameScreen');
  game.cvs = document.getElementById('gameCanvas');
  game.ctx = game.cvs.getContext('2d');
  game.cvs.width = window.innerWidth;
  game.cvs.height = window.innerHeight;
  
  game.players = [];
  game.bullets = [];
  game.scores = {void:0, peace:0};
  game.setupPhase = true;
  game.active = false;

  const m = maps[state.map];
  
  // PLAYER IS VOID
  game.players.push(spawnPlayer(150, 150, 'VOID', true));

  // DEFINE TEAM SIZES
  let voidCount = 0, peaceCount = 0;
  if(state.mode === '1v1') { peaceCount = 1; }
  else if(state.mode === '2v2') { voidCount = 1; peaceCount = 2; }
  else if(state.mode === '3v3') { voidCount = 2; peaceCount = 3; }
  else if(state.mode === 'tdm') { voidCount = 4; peaceCount = 5; }
  else if(state.mode === 'ffa') { peaceCount = 7; } // In FFA, all are enemies

  // SPAWN TEAMS
  for(let i=0; i<voidCount; i++) game.players.push(spawnPlayer(Math.random()*m.w, Math.random()*m.h, 'VOID', false));
  for(let i=0; i<peaceCount; i++) {
    const teamName = state.mode === 'ffa' ? 'PEACE_'+i : 'PEACE';
    game.players.push(spawnPlayer(Math.random()*m.w, Math.random()*m.h, teamName, false));
  }

  if(state.device === 'MOBILE') document.getElementById('mobileUI').classList.remove('hidden');
  else document.getElementById('mobileUI').classList.add('hidden');

  bindInput();
  runCountdown();
}

function runCountdown() {
  const layer = document.getElementById('countdownLayer');
  const valTxt = document.getElementById('countdownVal');
  layer.classList.remove('hidden');
  let c = 3;
  valTxt.innerText = c;
  const timer = setInterval(() => {
    c--;
    if(c > 0) valTxt.innerText = c;
    else if(c === 0) valTxt.innerText = 'GO';
    else {
      clearInterval(timer);
      layer.classList.add('hidden');
      game.active = true;
      game.setupPhase = false;
      game.startTime = Date.now();
      requestAnimationFrame(mainLoop);
    }
  }, 1000);
}

function spawnPlayer(x, y, team, isHuman) {
  const wk = isHuman ? state.weapon : Object.keys(weapons)[Math.floor(Math.random()*8)];
  const d = difficulties[state.difficulty];
  return {
    x, y, team, isHuman,
    hp: isHuman ? 100 : d.hp, maxHp: isHuman ? 100 : d.hp,
    wep: {...weapons[wk]}, ammo: weapons[wk].mag,
    angle: 0, recoil: 0, reloading: false, reloadRot: 0,
    lastFire: 0, target: null, aiTimer: 0
  };
}

function bindInput() {
  window.onkeydown = e => { game.keys[e.key.toLowerCase()] = true; if(e.key==='r') reload(game.players[0]); };
  window.onkeyup = e => { game.keys[e.key.toLowerCase()] = false; };
  window.onmousemove = e => { game.mouse.x = e.clientX; game.mouse.y = e.clientY; };
  window.onmousedown = () => game.mouse.down = true;
  window.onmouseup = () => game.mouse.down = false;

  if(state.device === 'MOBILE') {
    const base = document.getElementById('joyBase');
    base.ontouchmove = e => {
      e.preventDefault();
      const t = e.touches[0];
      const r = base.getBoundingClientRect();
      const dx = t.clientX - (r.left + r.width/2);
      const dy = t.clientY - (r.top + r.height/2);
      const dist = Math.min(50, Math.sqrt(dx*dx + dy*dy));
      const ang = Math.atan2(dy, dx);
      game.joy.dx = Math.cos(ang) * (dist/50);
      game.joy.dy = Math.sin(ang) * (dist/50);
      game.joy.active = true;
      document.getElementById('joyStick').style.left = `calc(50% + ${Math.cos(ang)*dist}px)`;
      document.getElementById('joyStick').style.top = `calc(50% + ${Math.sin(ang)*dist}px)`;
    };
    base.ontouchend = () => { game.joy.active = false; document.getElementById('joyStick').style.left='50%'; document.getElementById('joyStick').style.top='50%'; };
    document.getElementById('fireBtn').ontouchstart = () => game.mouse.down = true;
    document.getElementById('fireBtn').ontouchend = () => game.mouse.down = false;
    document.getElementById('reloadBtn').onclick = () => reload(game.players[0]);
  }
}

function reload(p) {
  if(!p || p.reloading || p.ammo === p.wep.mag) return;
  p.reloading = true;
  AudioSys.play('reload');
  let start = Date.now();
  let ms = p.wep.reload * 1000;
  const step = () => {
    let elap = Date.now() - start;
    p.reloadRot = (elap / ms) * Math.PI * 2;
    if(elap < ms) requestAnimationFrame(step);
    else { p.ammo = p.wep.mag; p.reloading = false; p.reloadRot = 0; }
  };
  step();
}

function mainLoop() {
  if(!game.active) return;
  update();
  draw();
  requestAnimationFrame(mainLoop);
}

function update() {
  const m = maps[state.map];
  const d = difficulties[state.difficulty];

  game.players.forEach(p => {
    if(p.hp <= 0) return;
    if(p.isHuman) {
      let vx = 0, vy = 0;
      if(state.device === 'MOBILE' && game.joy.active) {
        vx = game.joy.dx * 5.5; vy = game.joy.dy * 5.5;
        p.angle = Math.atan2(vy, vx);
      } else {
        if(game.keys.w) vy -= 5.5; if(game.keys.s) vy += 5.5;
        if(game.keys.a) vx -= 5.5; if(game.keys.d) vx += 5.5;
        p.angle = Math.atan2(game.mouse.y - game.cvs.height/2, game.mouse.x - game.cvs.width/2);
      }
      p.x += vx; p.y += vy;
      if(game.mouse.down) fire(p);
      
      // Update HUD
      document.getElementById('curAmmo').innerText = p.ammo;
      document.getElementById('curMag').innerText = p.wep.mag;
      document.getElementById('curHP').style.width = p.hp + '%';
      document.getElementById('curWep').innerText = p.wep.name;
    } else {
      updateAI(p, m, d);
    }

    // Walls
    p.x = Math.max(25, Math.min(m.w - 25, p.x));
    p.y = Math.max(25, Math.min(m.h - 25, p.y));
    m.objs.forEach(o => {
      if(collide(p.x, p.y, 22, o)) {
        const a = Math.atan2(p.y - (o.y+o.h/2), p.x - (o.x+o.w/2));
        p.x += Math.cos(a)*5; p.y += Math.sin(a)*5;
      }
    });
    p.recoil *= 0.82;
  });

  // Bullets
  game.bullets = game.bullets.filter(b => {
    b.x += b.vx; b.y += b.vy;
    let hit = false;
    m.objs.forEach(o => { if(b.x > o.x && b.x < o.x+o.w && b.y > o.y && b.y < o.y+o.h) hit = true; });
    game.players.forEach(p => {
      if(p.hp > 0 && p.team !== b.team) {
        if(Math.sqrt((b.x-p.x)**2 + (b.y-p.y)**2) < 26) {
          p.hp -= b.dmg; hit = true;
          if(b.fromPlayer) AudioSys.play('hit');
          if(p.hp <= 0) { 
            if(b.team === 'VOID') game.scores.void++; 
            else game.scores.peace++; 
          }
        }
      }
    });
    return !hit && b.x > 0 && b.x < m.w && b.y > 0 && b.y < m.h;
  });

  game.cam.x = game.players[0].x - game.cvs.width/2;
  game.cam.y = game.players[0].y - game.cvs.height/2;
  document.getElementById('sVoid').innerText = game.scores.void;
  document.getElementById('sPeace').innerText = game.scores.peace;
  
  if(!game.setupPhase) checkGameState();
}

function updateAI(p, m, d) {
  let target = null, minDist = 600;
  game.players.forEach(other => {
    if(other.hp > 0 && other.team !== p.team) {
      let dist = Math.sqrt((other.x-p.x)**2 + (other.y-p.y)**2);
      if(dist < minDist) { target = other; minDist = dist; }
    }
  });

  if(target) {
    p.angle = Math.atan2(target.y - p.y, target.x - p.x);
    if(minDist > 180) { p.x += Math.cos(p.angle)*d.speed*2; p.y += Math.sin(p.angle)*d.speed*2; }
    if(minDist < 450) fire(p);
  } else {
    p.aiTimer--;
    if(p.aiTimer <= 0) {
      p.target = { x: Math.random()*m.w, y: Math.random()*m.h };
      p.aiTimer = 120 + Math.random()*100;
    }
    if(p.target) {
      let a = Math.atan2(p.target.y - p.y, p.target.x - p.x);
      p.angle = a; p.x += Math.cos(a)*d.speed; p.y += Math.sin(a)*d.speed;
    }
  }
  if(p.ammo <= 0) reload(p);
}

function fire(p) {
  const now = Date.now();
  if(p.reloading || p.ammo <= 0 || now - p.lastFire < p.wep.rate) return;
  p.ammo--; p.lastFire = now; p.recoil = 12;
  if(p.isHuman) AudioSys.play('fire');
  const spread = (Math.random() - 0.5) * p.wep.acc;
  const dmg = p.isHuman ? p.wep.dmg : p.wep.dmg * 0.5;
  game.bullets.push({
    x: p.x + Math.cos(p.angle)*35, y: p.y + Math.sin(p.angle)*35,
    vx: Math.cos(p.angle + spread)*16, vy: Math.sin(p.angle + spread)*16,
    dmg, team: p.team, fromPlayer: p.isHuman
  });
}

function draw() {
  const m = maps[state.map];
  game.ctx.clearRect(0,0,game.cvs.width, game.cvs.height);
  game.ctx.save();
  game.ctx.translate(-game.cam.x, -game.cam.y);
  
  // Floor
  game.ctx.fillStyle = m.bg; game.ctx.fillRect(0,0,m.w, m.h);
  game.ctx.strokeStyle = 'rgba(255,255,255,0.03)';
  for(let i=0; i<m.w; i+=100) { game.ctx.beginPath(); game.ctx.moveTo(i,0); game.ctx.lineTo(i,m.h); game.ctx.stroke(); }
  for(let i=0; i<m.h; i+=100) { game.ctx.beginPath(); game.ctx.moveTo(0,i); game.ctx.lineTo(m.w,i); game.ctx.stroke(); }

  // Obstacles
  game.ctx.fillStyle = '#0a0a0f';
  m.objs.forEach(o => {
    if(o.s === 'c') { game.ctx.beginPath(); game.ctx.arc(o.x+o.w/2, o.y+o.h/2, o.w/2,0,Math.PI*2); game.ctx.fill(); }
    else game.ctx.fillRect(o.x, o.y, o.w, o.h);
  });

  // Players
  game.players.forEach(p => {
    if(p.hp <= 0) return;
    game.ctx.save();
    game.ctx.translate(p.x, p.y);
    
    // Circle Body
    game.ctx.shadowBlur = 15;
    game.ctx.shadowColor = (p.team === 'VOID' || p.team.startsWith('VOID')) ? varToHex('--neon-void') : varToHex('--neon-peace');
    game.ctx.fillStyle = game.ctx.shadowColor;
    game.ctx.beginPath(); game.ctx.arc(0,0,24,0,Math.PI*2); game.ctx.fill();
    game.ctx.shadowBlur = 0;

    // Gun
    game.ctx.rotate(p.angle);
    if(p.reloading) game.ctx.rotate(p.reloadRot);
    let gx = 18 - p.recoil;
    game.ctx.fillStyle = p.wep.color;
    game.ctx.fillRect(gx, 12, 38, 11);
    game.ctx.restore();

    // HP Bar
    game.ctx.fillStyle = 'rgba(0,0,0,0.6)'; game.ctx.fillRect(p.x-25, p.y-40, 50, 5);
    game.ctx.fillStyle = p.hp > 30 ? varToHex('--neon-green') : 'red';
    game.ctx.fillRect(p.x-25, p.y-40, 50*(p.hp/p.maxHp), 5);
  });

  // Bullets
  game.ctx.fillStyle = '#ff0';
  game.bullets.forEach(b => { game.ctx.beginPath(); game.ctx.arc(b.x, b.y, 3.5, 0, Math.PI*2); game.ctx.fill(); });
  game.ctx.restore();
}

function checkGameState() {
  if(Date.now() - game.startTime < 2500) return; // Protection period

  const voidAlive = game.players.filter(p => (p.team==='VOID') && p.hp > 0).length;
  const peaceAlive = game.players.filter(p => p.team.startsWith('PEACE') && p.hp > 0).length;

  if(state.mode === 'ffa') {
    const totalAlive = game.players.filter(p => p.hp > 0);
    if(totalAlive.length <= 1) finalizeMission(totalAlive[0] ? totalAlive[0].team + " DOMINATED" : "DRAW");
  } else {
    if(voidAlive === 0) finalizeMission("PEACE CONTROLLED");
    else if(peaceAlive === 0) finalizeMission("VOID SUPREMACY");
  }
}

function finalizeMission(msg) {
  game.active = false;
  document.getElementById('gameOverScreen').classList.remove('hidden');
  document.getElementById('victoryTxt').innerText = msg;
  document.getElementById('finalScore').innerText = `VOID: ${game.scores.void} | PEACE: ${game.scores.peace}`;
}

function abortMission() { game.active = false; showScreen('mainMenu'); }
function collide(cx, cy, r, rect) {
  let x = Math.max(rect.x, Math.min(cx, rect.x + rect.w));
  let y = Math.max(rect.y, Math.min(cy, rect.y + rect.h));
  return ((cx-x)**2 + (cy-y)**2) < r**2;
}
function varToHex(v) { return v === '--neon-void' ? '#f0f' : (v === '--neon-peace' ? '#0ff' : '#0f3'); }

window.onload = () => { setTimeout(() => showScreen('mainMenu'), 1500); };
</script>
</body>
</html>
