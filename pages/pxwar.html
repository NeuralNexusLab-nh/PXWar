<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>PX War</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Arial', sans-serif;
  background: #1a1a2e;
  color: #eee;
  overflow: hidden;
  width: 100vw;
  height: 100vh;
  position: relative;
}

#app {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.loading-screen {
  text-align: center;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #444;
  border-top-color: #0f3;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.btn {
  background: #16213e;
  border: 2px solid #0f3;
  color: #eee;
  padding: 12px 24px;
  font-size: 16px;
  cursor: pointer;
  border-radius: 5px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-width: 240px;
  gap: 15px;
  margin: 5px;
}

.btn:hover {
  background: #0f3;
  color: #000;
  transform: scale(1.05);
}

.main-menu {
  text-align: center;
}

.main-menu h1 {
  font-size: 48px;
  margin-bottom: 40px;
  color: #0f3;
  text-shadow: 0 0 10px #0f3;
}

.menu-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  align-items: center;
}

.screen-container {
  text-align: center;
  max-width: 600px;
  width: 90%;
}

.screen-container h2 {
  font-size: 32px;
  margin-bottom: 20px;
  color: #0f3;
}

.weapon-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 20px;
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
}

.weapon-item {
  background: #16213e;
  border: 2px solid #444;
  padding: 15px;
  border-radius: 5px;
  cursor: pointer;
  text-align: left;
}

.weapon-item.selected {
  border-color: #0f3;
  background: #1a3820;
}

.vote-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.vote-card {
  background: #16213e;
  border: 2px solid #444;
  padding: 20px;
  cursor: pointer;
  border-radius: 8px;
  position: relative;
}

.vote-card.voted {
  border-color: #0f3;
  background: #1a3820;
}

.vote-count {
  position: absolute;
  top: 5px;
  right: 5px;
  background: #0f3;
  color: #000;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
}

#gameCanvas {
  display: block;
  background: #0a0a0a;
  cursor: crosshair;
}

.hud-top-left {
  position: absolute;
  top: 20px;
  left: 20px;
  z-index: 500;
}

.exit-btn {
  background: rgba(255, 0, 0, 0.4);
  border: 2px solid #f33;
  color: #fff;
  padding: 10px 20px;
  cursor: pointer;
  border-radius: 5px;
  font-weight: bold;
}

.game-hud {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px;
  pointer-events: none;
  z-index: 100;
}

.score-display {
  display: flex;
  justify-content: center;
  gap: 50px;
  font-size: 24px;
  font-weight: bold;
}

.team-score {
  padding: 5px 15px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 5px;
}

.team-void { color: #f0f; }
.team-peace { color: #0ff; }

.player-hud {
  position: absolute;
  bottom: 20px;
  left: 20px;
  background: rgba(0, 0, 0, 0.7);
  padding: 15px;
  border-radius: 5px;
}

.health-bar {
  width: 200px;
  height: 15px;
  background: #333;
  margin-top: 5px;
}

.health-fill {
  height: 100%;
  background: #0f3;
  transition: width 0.3s;
}

.focus-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 150;
  overflow: hidden;
}

.focus-circle {
  position: absolute;
  width: 500px;
  height: 500px;
  border: 2px solid rgba(255, 255, 0, 0.8);
  border-radius: 50%;
  box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
  pointer-events: none;
  transform: translate(-50%, -50%);
}

.countdown-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.countdown-text {
  font-size: 150px;
  color: #0f3;
  font-weight: bold;
  text-shadow: 0 0 20px #000;
}

.mobile-controls {
  position: absolute;
  bottom: 30px;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 40px;
  pointer-events: none;
  z-index: 200;
}

.joystick-container {
  width: 120px;
  height: 120px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  position: relative;
  pointer-events: all;
}

.joystick-stick {
  width: 50px;
  height: 50px;
  background: #0f3;
  border-radius: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  pointer-events: all;
}

.action-btn {
  width: 70px;
  height: 70px;
  background: rgba(0, 255, 51, 0.3);
  border: 2px solid #0f3;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  user-select: none;
}

.game-over-screen {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.95);
  padding: 50px;
  border: 3px solid #0f3;
  text-align: center;
  z-index: 2000;
}

.hidden { display: none !important; }
</style>
</head>
<body>
<div id="app">
  <div id="loadingScreen" class="loading-screen">
    <h2 id="statusText">CONNECTING PX WAR SERVER...</h2>
    <div class="spinner"></div>
    <div id="deviceSelection" class="hidden">
      <button class="btn" onclick="selectDevice('computer')">PC / KEY BOARD</button><br>
      <button class="btn" onclick="selectDevice('mobile')">MOBILE / BUTTON</button>
    </div>
  </div>

  <div id="mainMenu" class="main-menu hidden">
    <h1>PX WAR</h1>
    <div class="menu-buttons">
      <button class="btn" onclick="showModeSelection()">PLAY ‚öîÔ∏è</button>
      <button class="btn" onclick="showLoadout()">LOADOUT üî´</button>
      <button class="btn" onclick="showSettings()">SETTINGS ‚öôÔ∏è</button>
    </div>
  </div>

  <div id="modeSelection" class="screen-container hidden">
    <h2>SELECT MODE</h2>
    <div class="menu-buttons">
      <button class="btn" onclick="prepVote('1v1')">1v1 DUEL</button>
      <button class="btn" onclick="prepVote('2v2')">2v2 BATTLE</button>
      <button class="btn" onclick="prepVote('3v3')">3v3 SQUAD</button>
      <button class="btn" onclick="prepVote('tdm')">TEAM DEATHMATCH (5v5)</button>
      <button class="btn" onclick="prepVote('ffa')">FREE FOR ALL</button>
      <button class="btn" style="background:#444" onclick="showMenu()">BACK</button>
    </div>
  </div>

  <div id="voteScreen" class="screen-container hidden">
    <h2>VOTE FOR MAP</h2>
    <div id="voteGrid" class="vote-grid"></div>
    <button class="btn" id="startVoteBtn" style="margin: 0 auto; display:none" onclick="finalizeVote()">START GAME</button>
  </div>

  <div id="loadoutScreen" class="screen-container hidden">
    <h2>WEAPON LOADOUT</h2>
    <div id="weaponList" class="weapon-list"></div>
    <button class="btn" style="margin: 0 auto; background:#444" onclick="showMenu()">BACK</button>
  </div>

  <div id="settingsScreen" class="screen-container hidden">
    <h2>SETTINGS</h2>
    <div class="setting-item" style="text-align:center">
      <p>BOT DIFFICULTY</p>
      <button class="btn" id="diffBtn" onclick="toggleDiff()">NORMAL</button>
    </div>
    <button class="btn" style="margin: 0 auto; background:#444" onclick="showMenu()">BACK</button>
  </div>

  <div id="gameScreen" class="hidden">
    <div class="hud-top-left">
      <button class="exit-btn" onclick="exitToMenu()">EXIT</button>
    </div>
    
    <canvas id="gameCanvas"></canvas>

    <div class="game-hud">
      <div class="score-display">
        <div class="team-score team-void">VOID: <span id="voidScore">0</span></div>
        <div class="team-score team-peace">PEACE: <span id="peaceScore">0</span></div>
      </div>
    </div>

    <div class="player-hud">
      <div id="hudWeapon" style="color:#0f3; font-weight:bold">AK-47</div>
      <div>AMMO: <span id="hudAmmo">30</span> / <span id="hudMag">30</span></div>
      <div class="health-bar"><div id="hudHealth" class="health-fill" style="width: 100%"></div></div>
    </div>

    <div id="countdownLayer" class="countdown-overlay hidden">
      <div id="countdownVal" class="countdown-text">3</div>
    </div>

    <div id="focusOverlay" class="focus-overlay hidden">
      <div id="focusCircle" class="focus-circle"></div>
    </div>

    <div id="mobileControls" class="mobile-controls hidden">
      <div class="joystick-container" id="joyBase">
        <div class="joystick-stick" id="joyStick"></div>
      </div>
      <div class="action-buttons">
        <div class="action-btn" id="fireBtn">üî•</div>
        <div class="action-btn" id="reloadBtn">üîÑ</div>
        <div class="action-btn" id="aimBtn" style="font-size:14px">AIM</div>
      </div>
    </div>

    <div id="gameOverScreen" class="game-over-screen hidden">
      <h1 id="winStatus" style="font-size: 60px; margin-bottom: 20px;">VOID WIN!</h1>
      <p id="scoreSummary" style="margin-bottom:30px"></p>
      <button class="btn" style="margin: 10px auto" onclick="restartRound()">PLAY AGAIN</button>
      <button class="btn" style="margin: 10px auto; background:#444" onclick="exitToMenu()">MAIN MENU</button>
    </div>
  </div>
</div>

<script>
const weapons = {
  ak47: { name: 'AK47', damage: 35, acc: 0.1, mag: 30, reload: 2.5, rate: 110, color: '#8B4513' },
  mp5: { name: 'MP5', damage: 22, acc: 0.08, mag: 40, reload: 1.8, rate: 80, color: '#2F4F4F' },
  p90: { name: 'P90', damage: 22, acc: 0.05, mag: 50, reload: 2, rate: 30, color: '#2F4F4F' },
  awp: { name: 'AWP', damage: 100, acc: 0.005, mag: 5, reload: 3.8, rate: 1500, color: '#000' },
  m4a1: { name: 'M4A1', damage: 30, acc: 0.06, mag: 30, reload: 2.2, rate: 100, color: '#4B5320' },
  mp7: { name: 'MP7', damage: 18, acc: 0.12, mag: 40, reload: 1.6, rate: 65, color: '#333' },
  m14: { name: 'M14', damage: 55, acc: 0.04, mag: 20, reload: 2.8, rate: 300, color: '#654321' },
  m16: { name: 'M16', damage: 32, acc: 0.07, mag: 30, reload: 2.3, rate: 100, color: '#1a1a1a' },
  aug: { name: 'AUG', damage: 33, acc: 0.05, mag: 30, reload: 2.6, rate: 120, color: '#2d5a27' }
};

const maps = {
  airport: { name: 'AIRPORT', bg: '#444', objs: [{x:100, y:100, w:400, h:60}, {x:700, y:150, w:100, h:300}, {x:200, y:500, w:300, h:100}, {x:800, y:600, w:200, h:50}], w: 1400, h: 900 },
  school: { name: 'SCHOOL', bg: '#5a4d41', objs: [{x:0, y:300, w:500, h:20}, {x:700, y:300, w:500, h:20}, {x:550, y:0, w:20, h:800}, {x:200, y:100, w:100, h:100}], w: 1200, h: 800 },
  wasteland: { name: 'WASTELAND', bg: '#3d2b1f', objs: [{x:400, y:400, w:150, h:150, s:'c'}, {x:800, y:200, w:100, h:100, s:'c'}, {x:200, y:600, w:120, h:120, s:'c'}], w: 1300, h: 1000 },
  garden: { name: 'GARDEN', bg: '#1a4a1a', objs: [{x:200, y:200, w:80, h:80, c:'#f0f', s:'c'}, {x:900, y:200, w:80, h:80, c:'#0ff', s:'c'}, {x:550, y:450, w:100, h:100, c:'#ff0', s:'c'}], w: 1200, h: 800 },
  park: { name: 'PARK', bg: '#2d5a27', objs: [{x:100, y:400, w:200, h:40}, {x:900, y:400, w:200, h:40}, {x:500, y:100, w:200, h:40}, {x:500, y:700, w:200, h:40}], w: 1200, h: 850 }
};

let state = {
  device: 'computer',
  weapon: 'ak47',
  difficulty: 'normal',
  mode: 'tdm',
  map: 'airport',
  votes: {}
};

let game = {
  active: false,
  ready: false,
  players: [],
  bullets: [],
  cam: { x: 0, y: 0 },
  scores: { void: 0, peace: 0 },
  cvs: null, ctx: null,
  keys: {},
  mouse: {x:0, y:0, d:false, r:false},
  joy: {dx:0, dy:0, a:false}
};

function selectDevice(d) { state.device = d; showMenu(); }
function showMenu() { hideScreens(); document.getElementById('mainMenu').classList.remove('hidden'); }
function showModeSelection() { hideScreens(); document.getElementById('modeSelection').classList.remove('hidden'); }
function showLoadout() { hideScreens(); document.getElementById('loadoutScreen').classList.remove('hidden'); renderLoadout(); }
function showSettings() { hideScreens(); document.getElementById('settingsScreen').classList.remove('hidden'); }
function hideScreens() { document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden')); game.active = false; }

function renderLoadout() {
  const container = document.getElementById('weaponList');
  container.innerHTML = '';
  Object.keys(weapons).forEach(k => {
    const w = weapons[k];
    const div = document.createElement('div');
    div.className = `weapon-item ${state.weapon === k ? 'selected' : ''}`;
    div.innerHTML = `<strong>${w.name}</strong><br><small>DMG: ${w.damage} | MAG: ${w.mag}</small>`;
    div.onclick = () => { state.weapon = k; renderLoadout(); };
    container.appendChild(div);
  });
}

function toggleDiff() {
  state.difficulty = state.difficulty === 'normal' ? 'hard' : 'normal';
  document.getElementById('diffBtn').innerText = state.difficulty.toUpperCase();
}

function prepVote(mode) {
  state.mode = mode;
  hideScreens();
  document.getElementById('voteScreen').classList.remove('hidden');
  const grid = document.getElementById('voteGrid');
  grid.innerHTML = '';
  state.votes = {};
  
  const totalBots = (mode === 'tdm') ? 9 : (mode === '3v3' ? 5 : (mode === '2v2' ? 3 : (mode === '1v1' ? 1 : 7)));
  
  Object.keys(maps).forEach(k => {
    state.votes[k] = 0;
    const card = document.createElement('div');
    card.className = 'vote-card';
    card.id = 'card-' + k;
    card.innerHTML = `<strong>${maps[k].name}</strong><div class="vote-count" id="count-${k}">0</div>`;
    card.onclick = () => {
      document.querySelectorAll('.vote-card').forEach(c => c.classList.remove('voted'));
      card.classList.add('voted');
      handleBotVotes(k, totalBots);
    };
    grid.appendChild(card);
  });
}

function handleBotVotes(playerChoice, botCount) {
  Object.keys(state.votes).forEach(k => state.votes[k] = 0);
  state.votes[playerChoice]++;
  for(let i=0; i<botCount; i++) {
    const keys = Object.keys(maps);
    const rand = keys[Math.floor(Math.random()*keys.length)];
    state.votes[rand]++;
  }
  Object.keys(state.votes).forEach(k => {
    document.getElementById('count-' + k).innerText = state.votes[k];
  });
  document.getElementById('startVoteBtn').style.display = 'block';
}

function finalizeVote() {
  let max = -1;
  let winner = 'airport';
  Object.keys(state.votes).forEach(k => {
    if(state.votes[k] > max) { max = state.votes[k]; winner = k; }
  });
  state.map = winner;
  initGame();
}

function initGame() {
  hideScreens();
  document.getElementById('gameScreen').classList.remove('hidden');
  game.cvs = document.getElementById('gameCanvas');
  game.ctx = game.cvs.getContext('2d');
  game.cvs.width = window.innerWidth;
  game.cvs.height = window.innerHeight;
  
  game.players = [];
  game.bullets = [];
  game.scores = { void: 0, peace: 0 };
  game.ready = false;
  
  const m = maps[state.map];
  game.players.push(createPlayer(100, 100, 'VOID', true));
  
  let botCount = (state.mode === 'tdm') ? 9 : (state.mode === '3v3' ? 5 : (state.mode === '2v2' ? 3 : (state.mode === '1v1' ? 1 : 7)));
  for(let i=0; i<botCount; i++) {
    const team = (state.mode === 'ffa') ? 'BOT'+i : ((i < Math.floor(botCount/2)) ? 'VOID' : 'PEACE');
    game.players.push(createPlayer(Math.random()*m.w, Math.random()*m.h, team, false));
  }
  
  if(state.device === 'mobile') document.getElementById('mobileControls').classList.remove('hidden');
  
  setupInputs();
  startCountdown();
}

function startCountdown() {
  const layer = document.getElementById('countdownLayer');
  const text = document.getElementById('countdownVal');
  layer.classList.remove('hidden');
  let count = 3;
  text.innerText = count;
  const timer = setInterval(() => {
    count--;
    if(count > 0) text.innerText = count;
    else if(count === 0) text.innerText = 'GO!';
    else {
      clearInterval(timer);
      layer.classList.add('hidden');
      game.ready = true;
      game.active = true;
      requestAnimationFrame(gameLoop);
    }
  }, 1000);
}

function createPlayer(x, y, team, isPlayer) {
  const wk = isPlayer ? state.weapon : Object.keys(weapons)[Math.floor(Math.random()*8)];
  return {
    x, y, team, isPlayer, hp: 100, max: 100,
    wep: {...weapons[wk]}, ammo: weapons[wk].mag,
    angle: 0, vx: 0, vy: 0, rad: 20,
    reloading: false, lastFire: 0,
    target: {x,y}, timer: 0
  };
}

function setupInputs() {
  window.onkeydown = e => { game.keys[e.key.toLowerCase()] = true; if(e.key==='r') doReload(game.players[0]); };
  window.onkeyup = e => { game.keys[e.key.toLowerCase()] = false; };
  window.onmousemove = e => { game.mouse.x = e.clientX; game.mouse.y = e.clientY; };
  window.onmousedown = e => { if(e.button===0) game.mouse.d = true; if(e.button===2) game.mouse.r = true; };
  window.onmouseup = e => { if(e.button===0) game.mouse.d = false; if(e.button===2) game.mouse.r = false; };
  window.oncontextmenu = e => e.preventDefault();

  if(state.device === 'mobile') {
    const joy = document.getElementById('joyBase');
    joy.ontouchmove = e => {
      const t = e.touches[0];
      const r = joy.getBoundingClientRect();
      const dx = t.clientX - (r.left + r.width/2);
      const dy = t.clientY - (r.top + r.height/2);
      const dist = Math.min(50, Math.sqrt(dx*dx + dy*dy));
      const ang = Math.atan2(dy, dx);
      game.joy.dx = Math.cos(ang) * (dist/50);
      game.joy.dy = Math.sin(ang) * (dist/50);
      game.joy.a = true;
      document.getElementById('joyStick').style.left = `calc(50% + ${Math.cos(ang)*dist}px)`;
      document.getElementById('joyStick').style.top = `calc(50% + ${Math.sin(ang)*dist}px)`;
    };
    joy.ontouchend = () => { game.joy.a = false; document.getElementById('joyStick').style.left = '50%'; document.getElementById('joyStick').style.top = '50%'; };
    document.getElementById('fireBtn').ontouchstart = () => game.mouse.d = true;
    document.getElementById('fireBtn').ontouchend = () => game.mouse.d = false;
    document.getElementById('aimBtn').ontouchstart = () => game.mouse.r = true;
    document.getElementById('aimBtn').ontouchend = () => game.mouse.r = false;
    document.getElementById('reloadBtn').onclick = () => doReload(game.players[0]);
  }
}

function doReload(p) {
  if(!p || p.reloading || p.ammo === p.wep.mag) return;
  p.reloading = true;
  setTimeout(() => { p.ammo = p.wep.mag; p.reloading = false; }, p.wep.reload * 1000);
}

function gameLoop() {
  if(!game.active) return;
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

function update() {
  const m = maps[state.map];
  game.players.forEach(p => {
    if(p.hp <= 0) return;
    if(p.isPlayer) {
      let mx = 0, my = 0;
      if(game.joy.a) { mx = game.joy.dx * 4; my = game.joy.dy * 4; }
      else { if(game.keys.w) my -= 4; if(game.keys.s) my += 4; if(game.keys.a) mx -= 4; if(game.keys.d) mx += 4; }
      p.x += mx; p.y += my;
      p.angle = Math.atan2(game.mouse.y - game.cvs.height/2, game.mouse.x - game.cvs.width/2);
      if(game.mouse.d) fire(p);
      document.getElementById('hudAmmo').innerText = p.ammo;
      document.getElementById('hudMag').innerText = p.wep.mag;
      document.getElementById('hudHealth').style.width = p.hp + '%';
      document.getElementById('hudWeapon').innerText = p.wep.name;
    } else {
      updateBot(p, m);
    }
    p.x = Math.max(20, Math.min(m.w - 20, p.x));
    p.y = Math.max(20, Math.min(m.h - 20, p.y));
    m.objs.forEach(o => { if(checkCol(o, p)) { const ang = Math.atan2(p.y - (o.y+o.h/2), p.x - (o.x+o.w/2)); p.x += Math.cos(ang)*5; p.y += Math.sin(ang)*5; } });
  });

  game.bullets = game.bullets.filter(b => {
    b.x += b.vx; b.y += b.vy;
    let hit = false;
    m.objs.forEach(o => { if(b.x > o.x && b.x < o.x+o.w && b.y > o.y && b.y < o.y+o.h) hit = true; });
    game.players.forEach(p => {
      if(p.hp > 0 && p.team !== b.team) {
        if(Math.sqrt((b.x-p.x)**2 + (b.y-p.y)**2) < p.rad) {
          p.hp -= b.dmg; hit = true;
          if(p.hp <= 0) { if(b.team==='VOID') game.scores.void++; else if(b.team==='PEACE') game.scores.peace++; }
        }
      }
    });
    return !hit && b.x > 0 && b.x < m.w && b.y > 0 && b.y < m.h;
  });

  document.getElementById('voidScore').innerText = game.scores.void;
  document.getElementById('peaceScore').innerText = game.scores.peace;
  game.cam.x = game.players[0].x - game.cvs.width/2;
  game.cam.y = game.players[0].y - game.cvs.height/2;
  checkWin();
}

function updateBot(p, m) {
  const speed = 1.3;
  let near = null, minDist = 600;
  game.players.forEach(t => {
    if(t.hp > 0 && t.team !== p.team) {
      const d = Math.sqrt((t.x-p.x)**2 + (t.y-p.y)**2);
      if(d < minDist) {
        let blocked = false;
        m.objs.forEach(o => { if(lineRect(p.x, p.y, t.x, t.y, o)) blocked = true; });
        if(!blocked) { minDist = d; near = t; }
      }
    }
  });

  if(near) {
    p.angle = Math.atan2(near.y - p.y, near.x - p.x);
    if(minDist < 500) fire(p, true);
    if(minDist > 150) { p.x += Math.cos(p.angle)*speed; p.y += Math.sin(p.angle)*speed; }
  } else {
    p.timer--;
    if(p.timer <= 0) { p.target = {x: Math.random()*m.w, y: Math.random()*m.h}; p.timer = 150; }
    const ang = Math.atan2(p.target.y - p.y, p.target.x - p.x);
    p.angle = ang; p.x += Math.cos(ang)*speed; p.y += Math.sin(ang)*speed;
  }
  if(p.ammo <= 0) doReload(p);
}

function fire(p, bot = false) {
  const now = Date.now();
  if(p.reloading || p.ammo <= 0 || now - p.lastFire < p.wep.rate) return;
  p.ammo--; p.lastFire = now;
  const dmg = bot ? p.wep.damage/3 : p.wep.damage;
  const sp = (Math.random()-0.5)*p.wep.acc;
  game.bullets.push({ x: p.x+Math.cos(p.angle)*30, y: p.y+Math.sin(p.angle)*30, vx: Math.cos(p.angle+sp)*12, vy: Math.sin(p.angle+sp)*12, dmg, team: p.team });
}

function draw() {
  const m = maps[state.map];
  game.ctx.clearRect(0,0,game.cvs.width, game.cvs.height);
  game.ctx.save();
  game.ctx.translate(-game.cam.x, -game.cam.y);
  game.ctx.fillStyle = m.bg;
  game.ctx.fillRect(0,0,m.w, m.h);
  game.ctx.fillStyle = '#222';
  m.objs.forEach(o => { if(o.s==='c') { game.ctx.beginPath(); game.ctx.arc(o.x+o.w/2, o.y+o.h/2, o.w/2, 0, Math.PI*2); game.ctx.fill(); } else game.ctx.fillRect(o.x, o.y, o.w, o.h); });
  game.players.forEach(p => {
    if(p.hp <= 0) return;
    game.ctx.save();
    game.ctx.translate(p.x, p.y);
    game.ctx.fillStyle = p.team.startsWith('BOT') ? '#555' : (p.team === 'VOID' ? '#f0f' : '#0ff');
    game.ctx.beginPath(); game.ctx.arc(0,0,p.rad, 0, Math.PI*2); game.ctx.fill();
    game.ctx.rotate(p.angle);
    game.ctx.fillStyle = p.wep.color;
    game.ctx.fillRect(10, -5, 30, 10);
    game.ctx.restore();
    game.ctx.fillStyle = 'red'; game.ctx.fillRect(p.x-20, p.y-30, 40, 5);
    game.ctx.fillStyle = 'lime'; game.ctx.fillRect(p.x-20, p.y-30, 40*(p.hp/p.max), 5);
  });
  game.ctx.fillStyle = 'yellow';
  game.bullets.forEach(b => { game.ctx.beginPath(); game.ctx.arc(b.x, b.y, 3, 0, Math.PI*2); game.ctx.fill(); });
  game.ctx.restore();
  if(game.mouse.r) {
    document.getElementById('focusOverlay').classList.remove('hidden');
    const fc = document.getElementById('focusCircle');
    fc.style.left = game.mouse.x + 'px'; fc.style.top = game.mouse.y + 'px';
  } else document.getElementById('focusOverlay').classList.add('hidden');
}

function checkWin() {
  if(state.mode === 'ffa') {
    const alive = game.players.filter(p => p.hp > 0);
    if(alive.length <= 1) endGame(alive[0] ? alive[0].team + " WINS!" : "DRAW!");
    return;
  }
  const v = game.players.filter(p => p.team==='VOID' && p.hp > 0).length;
  const p = game.players.filter(p => p.team==='PEACE' && p.hp > 0).length;
  if(v === 0) endGame("PEACE WIN!");
  else if(p === 0) endGame("VOID WIN!");
}

function endGame(txt) {
  game.active = false;
  document.getElementById('gameOverScreen').classList.remove('hidden');
  document.getElementById('winStatus').innerText = txt;
  document.getElementById('scoreSummary').innerText = `VOID: ${game.scores.void} | PEACE: ${game.scores.peace}`;
}

function restartRound() { document.getElementById('gameOverScreen').classList.add('hidden'); initGame(); }
function exitToMenu() { game.active = false; showMenu(); }
function checkCol(r, c) {
  let dx = Math.abs(c.x - (r.x + r.w/2)), dy = Math.abs(c.y - (r.y + r.h/2));
  if(dx > (r.w/2 + c.rad) || dy > (r.h/2 + c.rad)) return false;
  if(dx <= (r.w/2) || dy <= (r.h/2)) return true;
  return (dx-r.w/2)**2 + (dy-r.h/2)**2 <= (c.rad**2);
}
function lineRect(x1, y1, x2, y2, r) {
  return lineLine(x1,y1,x2,y2, r.x,r.y,r.x,r.y+r.h) || lineLine(x1,y1,x2,y2, r.x+r.w,r.y,r.x+r.w,r.y+r.h) || lineLine(x1,y1,x2,y2, r.x,r.y,r.x+r.w,r.y) || lineLine(x1,y1,x2,y2, r.x,r.y+r.h,r.x+r.w,r.y+r.h);
}
function lineLine(x1, y1, x2, y2, x3, y3, x4, y4) {
  let uA = ((x4-x3)*(y1-y3)-(y4-y3)*(x1-x3))/((y4-y3)*(x2-x1)-(x4-x3)*(y2-y1));
  let uB = ((x2-x1)*(y1-y3)-(y2-y1)*(x1-x3))/((y4-y3)*(x2-x1)-(x4-x3)*(y2-y1));
  return uA>=0 && uA<=1 && uB>=0 && uB<=1;
}

window.onload = () => { setTimeout(() => { document.getElementById('statusText').innerText = 'READY'; document.getElementById('deviceSelection').classList.remove('hidden'); document.querySelector('.spinner').style.display='none'; }, 2000); };
</script>
</body>
</html>
